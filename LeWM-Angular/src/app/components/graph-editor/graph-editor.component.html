<div class="graph-editor">
  <div class="toolbar">
    <h3>Node Library</h3>
    <div class="node-buttons">
      <button *ngFor="let node of availableNodes" 
              (click)="addNode(node.type)"
              class="node-btn">
        + {{ node.label }}
      </button>
    </div>
    
    <div class="controls">
      <h4>Mode</h4>
      <div class="mode-controls">
        <button *ngFor="let mode of availableModes" 
                (click)="switchMode(mode.name)"
                [class.active]="currentMode?.name === mode.name"
                class="mode-btn">
          {{ mode.displayName }}
        </button>
      </div>
      
      <h4>Controls</h4>
      <button (click)="clearConnections()" class="clear-btn">
        Clear Edges
      </button>
      <div class="info">
        <p>Mode: {{ currentMode?.displayName || 'None' }}</p>
        <p>Selected: {{ selectedNodes.size }}</p>
        <small *ngIf="currentMode?.name === 'normal'">Click to select • Ctrl+Click for multi-select • Delete to remove • P for Pin Mode</small>
        <small *ngIf="currentMode?.name === 'pin-edit'">Click node to select • Click edges to add pins • Double-click edges for Advanced Layout • Double-click pins to rename • Esc to exit</small>
      </div>
    </div>
  </div>
  
  <div class="canvas-container">
    <svg #svgCanvas 
         class="graph-canvas"
         width="100%" 
         height="100%"
         (mousedown)="onSvgMouseDown($event)"
         (mousemove)="onMouseMove($event)"
         (mouseup)="onMouseUp($event)">
      
      <!-- Grid pattern (can be moved to a shared SVG defs component later) -->
      <defs>
        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
          <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#grid)" />
      
      <!-- Connection Lines -->
      <g *ngFor="let edge of edges$ | async" class="connection-line">
        <line [attr.x1]="getConnectionStartX(edge)" 
              [attr.y1]="getConnectionStartY(edge)"
              [attr.x2]="getConnectionEndX(edge)" 
              [attr.y2]="getConnectionEndY(edge)"
              stroke="#2196F3" 
              stroke-width="2"
              marker-end="url(#arrowhead)" />
      </g>

      <!-- Arrow marker definition -->
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#2196F3" />
        </marker>
      </defs>

      <!-- Graph Nodes -->
      <g *ngFor="let node of nodes$ | async" 
         [attr.id]="node.id"
         (mousedown)="onNodeMouseDown($event, node.id)"
         [attr.class]="'graph-node-group ' + (selectedNodes.has(node.id) ? 'selected' : '')">
        <rect [attr.x]="node.x" 
              [attr.y]="node.y" 
              [attr.width]="node.width" 
              [attr.height]="node.height"
              [attr.fill]="selectedNodes.has(node.id) ? '#4a90e2' : '#f0f0f0'"
              stroke="#333" 
              stroke-width="2"
              class="graph-node-body" />
        <text [attr.x]="node.x + node.width/2" 
              [attr.y]="node.y + node.height/2 + 5" 
              text-anchor="middle" 
              font-size="12" 
              font-weight="bold">
          {{ node.label }}
        </text>
        
        <!-- Connection Pins -->
        <g *ngIf="node.pins" class="pins">
          <circle *ngFor="let pin of node.pins"
                  [attr.cx]="node.x + pin.x"
                  [attr.cy]="node.y + pin.y"
                  r="3"
                  fill="#FF5722"
                  stroke="#333"
                  stroke-width="1"
                  class="pin"
                  [attr.data-node-id]="node.id"
                  [attr.data-pin-name]="pin.name"
                  (mousedown)="onPinMouseDown($event, node.id, pin.name)" />
          <text *ngFor="let pin of node.pins"
                [attr.x]="node.x + pin.x + 8"
                [attr.y]="node.y + pin.y + 4"
                font-size="10"
                fill="#666"
                class="pin-label">
            {{ pin.name }}
          </text>
        </g>
      </g>
      
      <!-- Selection box -->
      <rect *ngIf="selectionBox"
            [attr.x]="Math.min(selectionBox.startX, selectionBox.endX)"
            [attr.y]="Math.min(selectionBox.startY, selectionBox.endY)"
            [attr.width]="Math.abs(selectionBox.endX - selectionBox.startX)"
            [attr.height]="Math.abs(selectionBox.endY - selectionBox.startY)"
            fill="rgba(74, 144, 226, 0.2)"
            stroke="#4a90e2"
            stroke-width="2"
            stroke-dasharray="5,5"
            pointer-events="none" />
    </svg>
  </div>
  
  <!-- Pin Name Dialog -->
  <app-pin-name-dialog
    #pinDialog
    [isVisible]="showPinDialog"
    [side]="selectedSideForPin"
    (pinCreated)="onPinCreated($event)"
    (cancelled)="onPinDialogCancelled()">
  </app-pin-name-dialog>
  
  <!-- Bulk Pin Dialog -->
  <app-bulk-pin-dialog
    #bulkPinDialog
    [isVisible]="showBulkPinDialog"
    [side]="selectedSideForBulkPin"
    (pinsCreated)="onBulkPinsCreated($event)"
    (cancelled)="onBulkPinDialogCancelled()">
  </app-bulk-pin-dialog>
</div>